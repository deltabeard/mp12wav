/* public domain Simple, Minimalistic MPEG Layer 1 decoder - http://jonolick.com
 *
 * Revision History:
 * 	1.00 (2014-26-1) Initial release.
 *
 * Basic usage:
 * 	int hz, channels, outputSize;
 * 	short *output;
 * 	jo_read_mp1(input, inputSize, output, outputSize, hz, channels);
 * 	// Do something with the data here
 * 	free(output);
 *
 * 	*/

#ifndef JO_INCLUDE_MP1_H
#define JO_INCLUDE_MP1_H

#include <stdbool.h>
#include <limits.h>

static const float s_jo_multTbl[64] = {
	2.000000F,1.587401F,1.259921F,1.000000F,0.793701F,0.629961F,0.500000F,0.396850F,0.314980F,0.250000F,0.198425F,0.157490F,0.125000F,0.099213F,0.078745F,0.062500F,
	0.049606F,0.039373F,0.031250F,0.024803F,0.019686F,0.015625F,0.012402F,0.009843F,0.007812F,0.006201F,0.004922F,0.003906F,0.003100F,0.002461F,0.001953F,0.001550F,
	0.001230F,0.000977F,0.000775F,0.000615F,0.000488F,0.000388F,0.000308F,0.000244F,0.000194F,0.000154F,0.000122F,0.000097F,0.000077F,0.000061F,0.000048F,0.000038F,
	0.000031F,0.000024F,0.000019F,0.000015F,0.000012F,0.000010F,0.000008F,0.000006F,0.000005F,0.000004F,0.000003F,0.000002F,0.000002F,0.000002F,0.000001F,1e-20F
};

// l = i - 256;
// s = (i & 0x40) ? 1 : -1;
// windowTbl[(i/16)|((i%16)<<5)] = s * 20 * exp(-(l/112)*-(l/112)) * sin(l * M_PI*2 / 112) / l; 
static const float s_jo_windowTbl[512] = {
	-0.000000F,-0.000443F,0.003250F,-0.007004F,0.031082F,-0.078629F,0.100311F,-0.572037F,1.144989F,0.572037F,0.100311F,0.078629F,0.031082F,0.007004F,0.003250F,0.000443F,
	-0.000015F,-0.000473F,0.003326F,-0.007919F,0.030518F,-0.084183F,0.090927F,-0.600220F,1.144287F,0.543823F,0.108856F,0.073059F,0.031479F,0.006119F,0.003174F,0.000397F,
	-0.000015F,-0.000534F,0.003387F,-0.008865F,0.029785F,-0.089706F,0.080688F,-0.628296F,1.142212F,0.515610F,0.116577F,0.067520F,0.031738F,0.005295F,0.003082F,0.000366F,
	-0.000015F,-0.000580F,0.003433F,-0.009842F,0.028885F,-0.095169F,0.069595F,-0.656219F,1.138763F,0.487473F,0.123474F,0.061996F,0.031845F,0.004486F,0.002991F,0.000320F,
	-0.000015F,-0.000626F,0.003464F,-0.010849F,0.027802F,-0.100540F,0.057617F,-0.683914F,1.133926F,0.459473F,0.129578F,0.056534F,0.031815F,0.003723F,0.002899F,0.000290F,
	-0.000015F,-0.000687F,0.003479F,-0.011887F,0.026535F,-0.105820F,0.044785F,-0.711319F,1.127747F,0.431656F,0.134888F,0.051132F,0.031662F,0.003006F,0.002792F,0.000259F,
	-0.000015F,-0.000748F,0.003479F,-0.012939F,0.025085F,-0.110947F,0.031082F,-0.738373F,1.120224F,0.404083F,0.139450F,0.045837F,0.031387F,0.002335F,0.002686F,0.000244F,
	-0.000031F,-0.000809F,0.003464F,-0.014023F,0.023422F,-0.115921F,0.016510F,-0.765030F,1.111374F,0.376801F,0.143265F,0.040634F,0.031006F,0.001694F,0.002579F,0.000214F,
	-0.000031F,-0.000885F,0.003418F,-0.015121F,0.021576F,-0.120697F,0.001068F,-0.791214F,1.101212F,0.349869F,0.146362F,0.035553F,0.030533F,0.001099F,0.002457F,0.000198F,
	-0.000031F,-0.000961F,0.003372F,-0.016235F,0.019531F,-0.125259F,-0.015228F,-0.816864F,1.089783F,0.323318F,0.148773F,0.030609F,0.029938F,0.000549F,0.002350F,0.000168F,
	-0.000031F,-0.001038F,0.003281F,-0.017349F,0.017258F,-0.129562F,-0.032379F,-0.841949F,1.077118F,0.297211F,0.150497F,0.025818F,0.029282F,0.000031F,0.002243F,0.000153F,
	-0.000046F,-0.001114F,0.003174F,-0.018463F,0.014801F,-0.133591F,-0.050354F,-0.866364F,1.063217F,0.271591F,0.151596F,0.021179F,0.028534F,-0.000443F,0.002121F,0.000137F,
	-0.000046F,-0.001205F,0.003052F,-0.019577F,0.012115F,-0.137299F,-0.069168F,-0.890091F,1.048157F,0.246506F,0.152069F,0.016708F,0.027725F,-0.000870F,0.002014F,0.000122F,
	-0.000061F,-0.001297F,0.002884F,-0.020691F,0.009232F,-0.140671F,-0.088776F,-0.913055F,1.031937F,0.221985F,0.151962F,0.012421F,0.026840F,-0.001266F,0.001907F,0.000107F,
	-0.000061F,-0.001389F,0.002701F,-0.021790F,0.006134F,-0.143677F,-0.109161F,-0.935196F,1.014618F,0.198059F,0.151306F,0.008316F,0.025909F,-0.001617F,0.001785F,0.000107F,
	-0.000076F,-0.001480F,0.002487F,-0.022858F,0.002823F,-0.146255F,-0.130310F,-0.956482F,0.996246F,0.174789F,0.150116F,0.004395F,0.024933F,-0.001938F,0.001694F,0.000092F,
	-0.000076F,-0.001587F,0.002228F,-0.023911F,-0.000687F,-0.148422F,-0.152206F,-0.976852F,0.976852F,0.152206F,0.148422F,0.000687F,0.023911F,-0.002228F,0.001587F,0.000076F,
	-0.000092F,-0.001694F,0.001938F,-0.024933F,-0.004395F,-0.150116F,-0.174789F,-0.996246F,0.956482F,0.130310F,0.146255F,-0.002823F,0.022858F,-0.002487F,0.001480F,0.000076F,
	-0.000107F,-0.001785F,0.001617F,-0.025909F,-0.008316F,-0.151306F,-0.198059F,-1.014618F,0.935196F,0.109161F,0.143677F,-0.006134F,0.021790F,-0.002701F,0.001389F,0.000061F,
	-0.000107F,-0.001907F,0.001266F,-0.026840F,-0.012421F,-0.151962F,-0.221985F,-1.031937F,0.913055F,0.088776F,0.140671F,-0.009232F,0.020691F,-0.002884F,0.001297F,0.000061F,
	-0.000122F,-0.002014F,0.000870F,-0.027725F,-0.016708F,-0.152069F,-0.246506F,-1.048157F,0.890091F,0.069168F,0.137299F,-0.012115F,0.019577F,-0.003052F,0.001205F,0.000046F,
	-0.000137F,-0.002121F,0.000443F,-0.028534F,-0.021179F,-0.151596F,-0.271591F,-1.063217F,0.866364F,0.050354F,0.133591F,-0.014801F,0.018463F,-0.003174F,0.001114F,0.000046F,
	-0.000153F,-0.002243F,-0.000031F,-0.029282F,-0.025818F,-0.150497F,-0.297211F,-1.077118F,0.841949F,0.032379F,0.129562F,-0.017258F,0.017349F,-0.003281F,0.001038F,0.000031F,
	-0.000168F,-0.002350F,-0.000549F,-0.029938F,-0.030609F,-0.148773F,-0.323318F,-1.089783F,0.816864F,0.015228F,0.125259F,-0.019531F,0.016235F,-0.003372F,0.000961F,0.000031F,
	-0.000198F,-0.002457F,-0.001099F,-0.030533F,-0.035553F,-0.146362F,-0.349869F,-1.101212F,0.791214F,-0.001068F,0.120697F,-0.021576F,0.015121F,-0.003418F,0.000885F,0.000031F,
	-0.000214F,-0.002579F,-0.001694F,-0.031006F,-0.040634F,-0.143265F,-0.376801F,-1.111374F,0.765030F,-0.016510F,0.115921F,-0.023422F,0.014023F,-0.003464F,0.000809F,0.000031F,
	-0.000244F,-0.002686F,-0.002335F,-0.031387F,-0.045837F,-0.139450F,-0.404083F,-1.120224F,0.738373F,-0.031082F,0.110947F,-0.025085F,0.012939F,-0.003479F,0.000748F,0.000015F,
	-0.000259F,-0.002792F,-0.003006F,-0.031662F,-0.051132F,-0.134888F,-0.431656F,-1.127747F,0.711319F,-0.044785F,0.105820F,-0.026535F,0.011887F,-0.003479F,0.000687F,0.000015F,
	-0.000290F,-0.002899F,-0.003723F,-0.031815F,-0.056534F,-0.129578F,-0.459473F,-1.133926F,0.683914F,-0.057617F,0.100540F,-0.027802F,0.010849F,-0.003464F,0.000626F,0.000015F,
	-0.000320F,-0.002991F,-0.004486F,-0.031845F,-0.061996F,-0.123474F,-0.487473F,-1.138763F,0.656219F,-0.069595F,0.095169F,-0.028885F,0.009842F,-0.003433F,0.000580F,0.000015F,
	-0.000366F,-0.003082F,-0.005295F,-0.031738F,-0.067520F,-0.116577F,-0.515610F,-1.142212F,0.628296F,-0.080688F,0.089706F,-0.029785F,0.008865F,-0.003387F,0.000534F,0.000015F,
	-0.000397F,-0.003174F,-0.006119F,-0.031479F,-0.073059F,-0.108856F,-0.543823F,-1.144287F,0.600220F,-0.090927F,0.084183F,-0.030518F,0.007919F,-0.003326F,0.000473F,0.000015F,
};

// filterTbl[i][j] = cos(((M_PI/64*i+M_PI/4)*(2*j+1)));
static const float s_jo_filterTbl[64][32] = {
	{0.707107F,-0.707107F,-0.707107F,0.707107F,0.707107F,-0.707107F,-0.707107F,0.707107F,0.707107F,-0.707107F,-0.707107F,0.707107F,0.707107F,-0.707107F,-0.707107F,0.707107F,
		0.707107F,-0.707107F,-0.707107F,0.707107F,0.707107F,-0.707107F,-0.707107F,0.707107F,0.707107F,-0.707107F,-0.707107F,0.707107F,0.707107F,-0.707107F,-0.707107F,0.707107F},
	{0.671559F,-0.803208F,-0.514103F,0.903989F,0.336890F,-0.970031F,-0.146730F,0.998795F,-0.049068F,-0.989177F,0.242980F,0.941544F,-0.427555F,-0.857729F,0.595699F,0.740951F,
		-0.740951F,-0.595699F,0.857729F,0.427555F,-0.941544F,-0.242980F,0.989177F,0.049068F,-0.998795F,0.146730F,0.970031F,-0.336890F,-0.903989F,0.514103F,0.803208F,-0.671559F},
	{0.634393F,-0.881921F,-0.290285F,0.995185F,-0.098017F,-0.956940F,0.471397F,0.773010F,-0.773010F,-0.471397F,0.956940F,0.098017F,-0.995185F,0.290285F,0.881921F,-0.634393F,
		-0.634393F,0.881921F,0.290285F,-0.995185F,0.098017F,0.956940F,-0.471397F,-0.773010F,0.773010F,0.471397F,-0.956940F,-0.098017F,0.995185F,-0.290285F,-0.881921F,0.634393F},
	{0.595699F,-0.941544F,-0.049068F,0.970031F,-0.514103F,-0.671559F,0.903989F,0.146730F,-0.989177F,0.427555F,0.740951F,-0.857729F,-0.242980F,0.998795F,-0.336890F,-0.803208F,
		0.803208F,0.336890F,-0.998795F,0.242980F,0.857729F,-0.740951F,-0.427555F,0.989177F,-0.146730F,-0.903989F,0.671559F,0.514103F,-0.970031F,0.049068F,0.941544F,-0.595699F},
	{0.555570F,-0.980785F,0.195090F,0.831470F,-0.831470F,-0.195090F,0.980785F,-0.555570F,-0.555570F,0.980785F,-0.195090F,-0.831470F,0.831470F,0.195090F,-0.980785F,0.555570F,
		0.555570F,-0.980785F,0.195090F,0.831470F,-0.831470F,-0.195090F,0.980785F,-0.555570F,-0.555570F,0.980785F,-0.195090F,-0.831470F,0.831470F,0.195090F,-0.980785F,0.555570F},
	{0.514103F,-0.998795F,0.427555F,0.595699F,-0.989177F,0.336890F,0.671559F,-0.970031F,0.242980F,0.740951F,-0.941544F,0.146730F,0.803208F,-0.903989F,0.049068F,0.857729F,
		-0.857729F,-0.049068F,0.903989F,-0.803208F,-0.146730F,0.941544F,-0.740951F,-0.242980F,0.970031F,-0.671559F,-0.336890F,0.989177F,-0.595699F,-0.427555F,0.998795F,-0.514103F},
	{0.471397F,-0.995185F,0.634393F,0.290285F,-0.956940F,0.773010F,0.098017F,-0.881921F,0.881921F,-0.098017F,-0.773010F,0.956940F,-0.290285F,-0.634393F,0.995185F,-0.471397F,
		-0.471397F,0.995185F,-0.634393F,-0.290285F,0.956940F,-0.773010F,-0.098017F,0.881921F,-0.881921F,0.098017F,0.773010F,-0.956940F,0.290285F,0.634393F,-0.995185F,0.471397F},
	{0.427555F,-0.970031F,0.803208F,-0.049068F,-0.740951F,0.989177F,-0.514103F,-0.336890F,0.941544F,-0.857729F,0.146730F,0.671559F,-0.998795F,0.595699F,0.242980F,-0.903989F,
		0.903989F,-0.242980F,-0.595699F,0.998795F,-0.671559F,-0.146730F,0.857729F,-0.941544F,0.336890F,0.514103F,-0.989177F,0.740951F,0.049068F,-0.803208F,0.970031F,-0.427555F},
	{0.382683F,-0.923880F,0.923880F,-0.382683F,-0.382683F,0.923880F,-0.923880F,0.382683F,0.382683F,-0.923880F,0.923880F,-0.382683F,-0.382683F,0.923880F,-0.923880F,0.382683F,
		0.382683F,-0.923880F,0.923880F,-0.382683F,-0.382683F,0.923880F,-0.923880F,0.382683F,0.382683F,-0.923880F,0.923880F,-0.382683F,-0.382683F,0.923880F,-0.923880F,0.382683F},
	{0.336890F,-0.857729F,0.989177F,-0.671559F,0.049068F,0.595699F,-0.970031F,0.903989F,-0.427555F,-0.242980F,0.803208F,-0.998795F,0.740951F,-0.146730F,-0.514103F,0.941544F,
		-0.941544F,0.514103F,0.146730F,-0.740951F,0.998795F,-0.803208F,0.242980F,0.427555F,-0.903989F,0.970031F,-0.595699F,-0.049068F,0.671559F,-0.989177F,0.857729F,-0.336890F},
	{0.290285F,-0.773010F,0.995185F,-0.881921F,0.471397F,0.098017F,-0.634393F,0.956940F,-0.956940F,0.634393F,-0.098017F,-0.471397F,0.881921F,-0.995185F,0.773010F,-0.290285F,
		-0.290285F,0.773010F,-0.995185F,0.881921F,-0.471397F,-0.098017F,0.634393F,-0.956940F,0.956940F,-0.634393F,0.098017F,0.471397F,-0.881921F,0.995185F,-0.773010F,0.290285F},
	{0.242980F,-0.671559F,0.941544F,-0.989177F,0.803208F,-0.427555F,-0.049068F,0.514103F,-0.857729F,0.998795F,-0.903989F,0.595699F,-0.146730F,-0.336890F,0.740951F,-0.970031F,
		0.970031F,-0.740951F,0.336890F,0.146730F,-0.595699F,0.903989F,-0.998795F,0.857729F,-0.514103F,0.049068F,0.427555F,-0.803208F,0.989177F,-0.941544F,0.671559F,-0.242980F},
	{0.195090F,-0.555570F,0.831470F,-0.980785F,0.980785F,-0.831470F,0.555570F,-0.195090F,-0.195090F,0.555570F,-0.831470F,0.980785F,-0.980785F,0.831470F,-0.555570F,0.195090F,
		0.195090F,-0.555570F,0.831470F,-0.980785F,0.980785F,-0.831470F,0.555570F,-0.195090F,-0.195090F,0.555570F,-0.831470F,0.980785F,-0.980785F,0.831470F,-0.555570F,0.195090F},
	{0.146730F,-0.427555F,0.671559F,-0.857729F,0.970031F,-0.998795F,0.941544F,-0.803208F,0.595699F,-0.336890F,0.049068F,0.242980F,-0.514103F,0.740951F,-0.903989F,0.989177F,
		-0.989177F,0.903989F,-0.740951F,0.514103F,-0.242980F,-0.049068F,0.336890F,-0.595699F,0.803208F,-0.941544F,0.998795F,-0.970031F,0.857729F,-0.671559F,0.427555F,-0.146730F},
	{0.098017F,-0.290285F,0.471397F,-0.634393F,0.773010F,-0.881921F,0.956940F,-0.995185F,0.995185F,-0.956940F,0.881921F,-0.773010F,0.634393F,-0.471397F,0.290285F,-0.098017F,
		-0.098017F,0.290285F,-0.471397F,0.634393F,-0.773010F,0.881921F,-0.956940F,0.995185F,-0.995185F,0.956940F,-0.881921F,0.773010F,-0.634393F,0.471397F,-0.290285F,0.098017F},
	{0.049068F,-0.146730F,0.242980F,-0.336890F,0.427555F,-0.514103F,0.595699F,-0.671559F,0.740951F,-0.803208F,0.857729F,-0.903989F,0.941544F,-0.970031F,0.989177F,-0.998795F,
		0.998795F,-0.989177F,0.970031F,-0.941544F,0.903989F,-0.857729F,0.803208F,-0.740951F,0.671559F,-0.595699F,0.514103F,-0.427555F,0.336890F,-0.242980F,0.146730F,-0.049068F},
	{0.000000F,-0.000000F,0.000000F,-0.000000F,0.000000F,-0.000000F,-0.000000F,-0.000000F,-0.000000F,-0.000000F,-0.000000F,-0.000000F,-0.000000F,-0.000000F,-0.000000F,-0.000000F,
		0.000000F,-0.000000F,0.000000F,-0.000000F,0.000000F,-0.000000F,0.000000F,0.000000F,0.000000F,-0.000000F,0.000000F,0.000000F,0.000000F,-0.000000F,0.000000F,0.000000F},
	{-0.049068F,0.146730F,-0.242980F,0.336890F,-0.427555F,0.514103F,-0.595699F,0.671559F,-0.740951F,0.803208F,-0.857729F,0.903989F,-0.941544F,0.970031F,-0.989177F,0.998795F,
		-0.998795F,0.989177F,-0.970031F,0.941544F,-0.903989F,0.857729F,-0.803208F,0.740951F,-0.671559F,0.595699F,-0.514103F,0.427555F,-0.336890F,0.242980F,-0.146730F,0.049068F},
	{-0.098017F,0.290285F,-0.471397F,0.634393F,-0.773010F,0.881921F,-0.956940F,0.995185F,-0.995185F,0.956940F,-0.881921F,0.773010F,-0.634393F,0.471397F,-0.290285F,0.098017F,
		0.098017F,-0.290285F,0.471397F,-0.634393F,0.773010F,-0.881921F,0.956940F,-0.995185F,0.995185F,-0.956940F,0.881921F,-0.773010F,0.634393F,-0.471397F,0.290285F,-0.098017F},
	{-0.146730F,0.427555F,-0.671559F,0.857729F,-0.970031F,0.998795F,-0.941544F,0.803208F,-0.595699F,0.336890F,-0.049068F,-0.242980F,0.514103F,-0.740951F,0.903989F,-0.989177F,
		0.989177F,-0.903989F,0.740951F,-0.514103F,0.242980F,0.049068F,-0.336890F,0.595699F,-0.803208F,0.941544F,-0.998795F,0.970031F,-0.857729F,0.671559F,-0.427555F,0.146730F},
	{-0.195090F,0.555570F,-0.831470F,0.980785F,-0.980785F,0.831470F,-0.555570F,0.195090F,0.195090F,-0.555570F,0.831470F,-0.980785F,0.980785F,-0.831470F,0.555570F,-0.195090F,
		-0.195090F,0.555570F,-0.831470F,0.980785F,-0.980785F,0.831470F,-0.555570F,0.195090F,0.195090F,-0.555570F,0.831470F,-0.980785F,0.980785F,-0.831470F,0.555570F,-0.195090F},
	{-0.242980F,0.671559F,-0.941544F,0.989177F,-0.803208F,0.427555F,0.049068F,-0.514103F,0.857729F,-0.998795F,0.903989F,-0.595699F,0.146730F,0.336890F,-0.740951F,0.970031F,
		-0.970031F,0.740951F,-0.336890F,-0.146730F,0.595699F,-0.903989F,0.998795F,-0.857729F,0.514103F,-0.049068F,-0.427555F,0.803208F,-0.989177F,0.941544F,-0.671559F,0.242980F},
	{-0.290285F,0.773010F,-0.995185F,0.881921F,-0.471397F,-0.098017F,0.634393F,-0.956940F,0.956940F,-0.634393F,0.098017F,0.471397F,-0.881921F,0.995185F,-0.773010F,0.290285F,
		0.290285F,-0.773010F,0.995185F,-0.881921F,0.471397F,0.098017F,-0.634393F,0.956940F,-0.956940F,0.634393F,-0.098017F,-0.471397F,0.881921F,-0.995185F,0.773010F,-0.290285F},
	{-0.336890F,0.857729F,-0.989177F,0.671559F,-0.049068F,-0.595699F,0.970031F,-0.903989F,0.427555F,0.242980F,-0.803208F,0.998795F,-0.740951F,0.146730F,0.514103F,-0.941544F,
		0.941544F,-0.514103F,-0.146730F,0.740951F,-0.998795F,0.803208F,-0.242980F,-0.427555F,0.903989F,-0.970031F,0.595699F,0.049068F,-0.671559F,0.989177F,-0.857729F,0.336890F},
	{-0.382683F,0.923880F,-0.923880F,0.382683F,0.382683F,-0.923880F,0.923880F,-0.382683F,-0.382683F,0.923880F,-0.923880F,0.382683F,0.382683F,-0.923880F,0.923880F,-0.382683F,
		-0.382683F,0.923880F,-0.923880F,0.382683F,0.382683F,-0.923880F,0.923880F,-0.382683F,-0.382683F,0.923880F,-0.923880F,0.382683F,0.382683F,-0.923880F,0.923880F,-0.382683F},
	{-0.427555F,0.970031F,-0.803208F,0.049068F,0.740951F,-0.989177F,0.514103F,0.336890F,-0.941544F,0.857729F,-0.146730F,-0.671559F,0.998795F,-0.595699F,-0.242980F,0.903989F,
		-0.903989F,0.242980F,0.595699F,-0.998795F,0.671559F,0.146730F,-0.857729F,0.941544F,-0.336890F,-0.514103F,0.989177F,-0.740951F,-0.049068F,0.803208F,-0.970031F,0.427555F},
	{-0.471397F,0.995185F,-0.634393F,-0.290285F,0.956940F,-0.773010F,-0.098017F,0.881921F,-0.881921F,0.098017F,0.773010F,-0.956940F,0.290285F,0.634393F,-0.995185F,0.471397F,
		0.471397F,-0.995185F,0.634393F,0.290285F,-0.956940F,0.773010F,0.098017F,-0.881921F,0.881921F,-0.098017F,-0.773010F,0.956940F,-0.290285F,-0.634393F,0.995185F,-0.471397F},
	{-0.514103F,0.998795F,-0.427555F,-0.595699F,0.989177F,-0.336890F,-0.671559F,0.970031F,-0.242980F,-0.740951F,0.941544F,-0.146730F,-0.803208F,0.903989F,-0.049068F,-0.857729F,
		0.857729F,0.049068F,-0.903989F,0.803208F,0.146730F,-0.941544F,0.740951F,0.242980F,-0.970031F,0.671559F,0.336890F,-0.989177F,0.595699F,0.427555F,-0.998795F,0.514103F},
	{-0.555570F,0.980785F,-0.195090F,-0.831470F,0.831470F,0.195090F,-0.980785F,0.555570F,0.555570F,-0.980785F,0.195090F,0.831470F,-0.831470F,-0.195090F,0.980785F,-0.555570F,
		-0.555570F,0.980785F,-0.195090F,-0.831470F,0.831470F,0.195090F,-0.980785F,0.555570F,0.555570F,-0.980785F,0.195090F,0.831470F,-0.831470F,-0.195090F,0.980785F,-0.555570F},
	{-0.595699F,0.941544F,0.049068F,-0.970031F,0.514103F,0.671559F,-0.903989F,-0.146730F,0.989177F,-0.427555F,-0.740951F,0.857729F,0.242980F,-0.998795F,0.336890F,0.803208F,
		-0.803208F,-0.336890F,0.998795F,-0.242980F,-0.857729F,0.740951F,0.427555F,-0.989177F,0.146730F,0.903989F,-0.671559F,-0.514103F,0.970031F,-0.049068F,-0.941544F,0.595699F},
	{-0.634393F,0.881921F,0.290285F,-0.995185F,0.098017F,0.956940F,-0.471397F,-0.773010F,0.773010F,0.471397F,-0.956940F,-0.098017F,0.995185F,-0.290285F,-0.881921F,0.634393F,
		0.634393F,-0.881921F,-0.290285F,0.995185F,-0.098017F,-0.956940F,0.471397F,0.773010F,-0.773010F,-0.471397F,0.956940F,0.098017F,-0.995185F,0.290285F,0.881921F,-0.634393F},
	{-0.671559F,0.803208F,0.514103F,-0.903989F,-0.336890F,0.970031F,0.146730F,-0.998795F,0.049068F,0.989177F,-0.242980F,-0.941544F,0.427555F,0.857729F,-0.595699F,-0.740951F,
		0.740951F,0.595699F,-0.857729F,-0.427555F,0.941544F,0.242980F,-0.989177F,-0.049068F,0.998795F,-0.146730F,-0.970031F,0.336890F,0.903989F,-0.514103F,-0.803208F,0.671559F},
	{-0.707107F,0.707107F,0.707107F,-0.707107F,-0.707107F,0.707107F,0.707107F,-0.707107F,-0.707107F,0.707107F,0.707107F,-0.707107F,-0.707107F,0.707107F,0.707107F,-0.707107F,
		-0.707107F,0.707107F,0.707107F,-0.707107F,-0.707107F,0.707107F,0.707107F,-0.707107F,-0.707107F,0.707107F,0.707107F,-0.707107F,-0.707107F,0.707107F,0.707107F,-0.707107F},
	{-0.740951F,0.595699F,0.857729F,-0.427555F,-0.941544F,0.242980F,0.989177F,-0.049068F,-0.998795F,-0.146730F,0.970031F,0.336890F,-0.903989F,-0.514103F,0.803208F,0.671559F,
		-0.671559F,-0.803208F,0.514103F,0.903989F,-0.336890F,-0.970031F,0.146730F,0.998795F,0.049068F,-0.989177F,-0.242980F,0.941544F,0.427555F,-0.857729F,-0.595699F,0.740951F},
	{-0.773010F,0.471397F,0.956940F,-0.098017F,-0.995185F,-0.290285F,0.881921F,0.634393F,-0.634393F,-0.881921F,0.290285F,0.995185F,0.098017F,-0.956940F,-0.471397F,0.773010F,
		0.773010F,-0.471397F,-0.956940F,0.098017F,0.995185F,0.290285F,-0.881921F,-0.634393F,0.634393F,0.881921F,-0.290285F,-0.995185F,-0.098017F,0.956940F,0.471397F,-0.773010F},
	{-0.803208F,0.336890F,0.998795F,0.242980F,-0.857729F,-0.740951F,0.427555F,0.989177F,0.146730F,-0.903989F,-0.671559F,0.514103F,0.970031F,0.049068F,-0.941544F,-0.595699F,
		0.595699F,0.941544F,-0.049068F,-0.970031F,-0.514103F,0.671559F,0.903989F,-0.146730F,-0.989177F,-0.427555F,0.740951F,0.857729F,-0.242980F,-0.998795F,-0.336890F,0.803208F},
	{-0.831470F,0.195090F,0.980785F,0.555570F,-0.555570F,-0.980785F,-0.195090F,0.831470F,0.831470F,-0.195090F,-0.980785F,-0.555570F,0.555570F,0.980785F,0.195090F,-0.831470F,
		-0.831470F,0.195090F,0.980785F,0.555570F,-0.555570F,-0.980785F,-0.195090F,0.831470F,0.831470F,-0.195090F,-0.980785F,-0.555570F,0.555570F,0.980785F,0.195090F,-0.831470F},
	{-0.857729F,0.049068F,0.903989F,0.803208F,-0.146730F,-0.941544F,-0.740951F,0.242980F,0.970031F,0.671559F,-0.336890F,-0.989177F,-0.595699F,0.427555F,0.998795F,0.514103F,
		-0.514103F,-0.998795F,-0.427555F,0.595699F,0.989177F,0.336890F,-0.671559F,-0.970031F,-0.242980F,0.740951F,0.941544F,0.146730F,-0.803208F,-0.903989F,-0.049068F,0.857729F},
	{-0.881921F,-0.098017F,0.773010F,0.956940F,0.290285F,-0.634393F,-0.995185F,-0.471397F,0.471397F,0.995185F,0.634393F,-0.290285F,-0.956940F,-0.773010F,0.098017F,0.881921F,
		0.881921F,0.098017F,-0.773010F,-0.956940F,-0.290285F,0.634393F,0.995185F,0.471397F,-0.471397F,-0.995185F,-0.634393F,0.290285F,0.956940F,0.773010F,-0.098017F,-0.881921F},
	{-0.903989F,-0.242980F,0.595699F,0.998795F,0.671559F,-0.146730F,-0.857729F,-0.941544F,-0.336890F,0.514103F,0.989177F,0.740951F,-0.049068F,-0.803208F,-0.970031F,-0.427555F,
		0.427555F,0.970031F,0.803208F,0.049068F,-0.740951F,-0.989177F,-0.514103F,0.336890F,0.941544F,0.857729F,0.146730F,-0.671559F,-0.998795F,-0.595699F,0.242980F,0.903989F},
	{-0.923880F,-0.382683F,0.382683F,0.923880F,0.923880F,0.382683F,-0.382683F,-0.923880F,-0.923880F,-0.382683F,0.382683F,0.923880F,0.923880F,0.382683F,-0.382683F,-0.923880F,
		-0.923880F,-0.382683F,0.382683F,0.923880F,0.923880F,0.382683F,-0.382683F,-0.923880F,-0.923880F,-0.382683F,0.382683F,0.923880F,0.923880F,0.382683F,-0.382683F,-0.923880F},
	{-0.941544F,-0.514103F,0.146730F,0.740951F,0.998795F,0.803208F,0.242980F,-0.427555F,-0.903989F,-0.970031F,-0.595699F,0.049068F,0.671559F,0.989177F,0.857729F,0.336890F,
		-0.336890F,-0.857729F,-0.989177F,-0.671559F,-0.049068F,0.595699F,0.970031F,0.903989F,0.427555F,-0.242980F,-0.803208F,-0.998795F,-0.740951F,-0.146730F,0.514103F,0.941544F},
	{-0.956940F,-0.634393F,-0.098017F,0.471397F,0.881921F,0.995185F,0.773010F,0.290285F,-0.290285F,-0.773010F,-0.995185F,-0.881921F,-0.471397F,0.098017F,0.634393F,0.956940F,
		0.956940F,0.634393F,0.098017F,-0.471397F,-0.881921F,-0.995185F,-0.773010F,-0.290285F,0.290285F,0.773010F,0.995185F,0.881921F,0.471397F,-0.098017F,-0.634393F,-0.956940F},
	{-0.970031F,-0.740951F,-0.336890F,0.146730F,0.595699F,0.903989F,0.998795F,0.857729F,0.514103F,0.049068F,-0.427555F,-0.803208F,-0.989177F,-0.941544F,-0.671559F,-0.242980F,
		0.242980F,0.671559F,0.941544F,0.989177F,0.803208F,0.427555F,-0.049068F,-0.514103F,-0.857729F,-0.998795F,-0.903989F,-0.595699F,-0.146730F,0.336890F,0.740951F,0.970031F},
	{-0.980785F,-0.831470F,-0.555570F,-0.195090F,0.195090F,0.555570F,0.831470F,0.980785F,0.980785F,0.831470F,0.555570F,0.195090F,-0.195090F,-0.555570F,-0.831470F,-0.980785F,
		-0.980785F,-0.831470F,-0.555570F,-0.195090F,0.195090F,0.555570F,0.831470F,0.980785F,0.980785F,0.831470F,0.555570F,0.195090F,-0.195090F,-0.555570F,-0.831470F,-0.980785F},
	{-0.989177F,-0.903989F,-0.740951F,-0.514103F,-0.242980F,0.049068F,0.336890F,0.595699F,0.803208F,0.941544F,0.998795F,0.970031F,0.857729F,0.671559F,0.427555F,0.146730F,
		-0.146730F,-0.427555F,-0.671559F,-0.857729F,-0.970031F,-0.998795F,-0.941544F,-0.803208F,-0.595699F,-0.336890F,-0.049068F,0.242980F,0.514103F,0.740951F,0.903989F,0.989177F},
	{-0.995185F,-0.956940F,-0.881921F,-0.773010F,-0.634393F,-0.471397F,-0.290285F,-0.098017F,0.098017F,0.290285F,0.471397F,0.634393F,0.773010F,0.881921F,0.956940F,0.995185F,
		0.995185F,0.956940F,0.881921F,0.773010F,0.634393F,0.471397F,0.290285F,0.098017F,-0.098017F,-0.290285F,-0.471397F,-0.634393F,-0.773010F,-0.881921F,-0.956940F,-0.995185F},
	{-0.998795F,-0.989177F,-0.970031F,-0.941544F,-0.903989F,-0.857729F,-0.803208F,-0.740951F,-0.671559F,-0.595699F,-0.514103F,-0.427555F,-0.336890F,-0.242980F,-0.146730F,-0.049068F,
		0.049068F,0.146730F,0.242980F,0.336890F,0.427555F,0.514103F,0.595699F,0.671559F,0.740951F,0.803208F,0.857729F,0.903989F,0.941544F,0.970031F,0.989177F,0.998795F},
	{-1.000000F,-1.000000F,-1.000000F,-1.000000F,-1.000000F,-1.000000F,-1.000000F,-1.000000F,-1.000000F,-1.000000F,-1.000000F,-1.000000F,-1.000000F,-1.000000F,-1.000000F,-1.000000F,
		-1.000000F,-1.000000F,-1.000000F,-1.000000F,-1.000000F,-1.000000F,-1.000000F,-1.000000F,-1.000000F,-1.000000F,-1.000000F,-1.000000F,-1.000000F,-1.000000F,-1.000000F,-1.000000F},
	{-0.998795F,-0.989177F,-0.970031F,-0.941544F,-0.903989F,-0.857729F,-0.803208F,-0.740951F,-0.671559F,-0.595699F,-0.514103F,-0.427555F,-0.336890F,-0.242980F,-0.146730F,-0.049068F,
		0.049068F,0.146730F,0.242980F,0.336890F,0.427555F,0.514103F,0.595699F,0.671559F,0.740951F,0.803208F,0.857729F,0.903989F,0.941544F,0.970031F,0.989177F,0.998795F},
	{-0.995185F,-0.956940F,-0.881921F,-0.773010F,-0.634393F,-0.471397F,-0.290285F,-0.098017F,0.098017F,0.290285F,0.471397F,0.634393F,0.773010F,0.881921F,0.956940F,0.995185F,
		0.995185F,0.956940F,0.881921F,0.773010F,0.634393F,0.471397F,0.290285F,0.098017F,-0.098017F,-0.290285F,-0.471397F,-0.634393F,-0.773010F,-0.881921F,-0.956940F,-0.995185F},
	{-0.989177F,-0.903989F,-0.740951F,-0.514103F,-0.242980F,0.049068F,0.336890F,0.595699F,0.803208F,0.941544F,0.998795F,0.970031F,0.857729F,0.671559F,0.427555F,0.146730F,
		-0.146730F,-0.427555F,-0.671559F,-0.857729F,-0.970031F,-0.998795F,-0.941544F,-0.803208F,-0.595699F,-0.336890F,-0.049068F,0.242980F,0.514103F,0.740951F,0.903989F,0.989177F},
	{-0.980785F,-0.831470F,-0.555570F,-0.195090F,0.195090F,0.555570F,0.831470F,0.980785F,0.980785F,0.831470F,0.555570F,0.195090F,-0.195090F,-0.555570F,-0.831470F,-0.980785F,
		-0.980785F,-0.831470F,-0.555570F,-0.195090F,0.195090F,0.555570F,0.831470F,0.980785F,0.980785F,0.831470F,0.555570F,0.195090F,-0.195090F,-0.555570F,-0.831470F,-0.980785F},
	{-0.970031F,-0.740951F,-0.336890F,0.146730F,0.595699F,0.903989F,0.998795F,0.857729F,0.514103F,0.049068F,-0.427555F,-0.803208F,-0.989177F,-0.941544F,-0.671559F,-0.242980F,
		0.242980F,0.671559F,0.941544F,0.989177F,0.803208F,0.427555F,-0.049068F,-0.514103F,-0.857729F,-0.998795F,-0.903989F,-0.595699F,-0.146730F,0.336890F,0.740951F,0.970031F},
	{-0.956940F,-0.634393F,-0.098017F,0.471397F,0.881921F,0.995185F,0.773010F,0.290285F,-0.290285F,-0.773010F,-0.995185F,-0.881921F,-0.471397F,0.098017F,0.634393F,0.956940F,
		0.956940F,0.634393F,0.098017F,-0.471397F,-0.881921F,-0.995185F,-0.773010F,-0.290285F,0.290285F,0.773010F,0.995185F,0.881921F,0.471397F,-0.098017F,-0.634393F,-0.956940F},
	{-0.941544F,-0.514103F,0.146730F,0.740951F,0.998795F,0.803208F,0.242980F,-0.427555F,-0.903989F,-0.970031F,-0.595699F,0.049068F,0.671559F,0.989177F,0.857729F,0.336890F,
		-0.336890F,-0.857729F,-0.989177F,-0.671559F,-0.049068F,0.595699F,0.970031F,0.903989F,0.427555F,-0.242980F,-0.803208F,-0.998795F,-0.740951F,-0.146730F,0.514103F,0.941544F},
	{-0.923880F,-0.382683F,0.382683F,0.923880F,0.923880F,0.382683F,-0.382683F,-0.923880F,-0.923880F,-0.382683F,0.382683F,0.923880F,0.923880F,0.382683F,-0.382683F,-0.923880F,
		-0.923880F,-0.382683F,0.382683F,0.923880F,0.923880F,0.382683F,-0.382683F,-0.923880F,-0.923880F,-0.382683F,0.382683F,0.923880F,0.923880F,0.382683F,-0.382683F,-0.923880F},
	{-0.903989F,-0.242980F,0.595699F,0.998795F,0.671559F,-0.146730F,-0.857729F,-0.941544F,-0.336890F,0.514103F,0.989177F,0.740951F,-0.049068F,-0.803208F,-0.970031F,-0.427555F,
		0.427555F,0.970031F,0.803208F,0.049068F,-0.740951F,-0.989177F,-0.514103F,0.336890F,0.941544F,0.857729F,0.146730F,-0.671559F,-0.998795F,-0.595699F,0.242980F,0.903989F},
	{-0.881921F,-0.098017F,0.773010F,0.956940F,0.290285F,-0.634393F,-0.995185F,-0.471397F,0.471397F,0.995185F,0.634393F,-0.290285F,-0.956940F,-0.773010F,0.098017F,0.881921F,
		0.881921F,0.098017F,-0.773010F,-0.956940F,-0.290285F,0.634393F,0.995185F,0.471397F,-0.471397F,-0.995185F,-0.634393F,0.290285F,0.956940F,0.773010F,-0.098017F,-0.881921F},
	{-0.857729F,0.049068F,0.903989F,0.803208F,-0.146730F,-0.941544F,-0.740951F,0.242980F,0.970031F,0.671559F,-0.336890F,-0.989177F,-0.595699F,0.427555F,0.998795F,0.514103F,
		-0.514103F,-0.998795F,-0.427555F,0.595699F,0.989177F,0.336890F,-0.671559F,-0.970031F,-0.242980F,0.740951F,0.941544F,0.146730F,-0.803208F,-0.903989F,-0.049068F,0.857729F},
	{-0.831470F,0.195090F,0.980785F,0.555570F,-0.555570F,-0.980785F,-0.195090F,0.831470F,0.831470F,-0.195090F,-0.980785F,-0.555570F,0.555570F,0.980785F,0.195090F,-0.831470F,
		-0.831470F,0.195090F,0.980785F,0.555570F,-0.555570F,-0.980785F,-0.195090F,0.831470F,0.831470F,-0.195090F,-0.980785F,-0.555570F,0.555570F,0.980785F,0.195090F,-0.831470F},
	{-0.803208F,0.336890F,0.998795F,0.242980F,-0.857729F,-0.740951F,0.427555F,0.989177F,0.146730F,-0.903989F,-0.671559F,0.514103F,0.970031F,0.049068F,-0.941544F,-0.595699F,
		0.595699F,0.941544F,-0.049068F,-0.970031F,-0.514103F,0.671559F,0.903989F,-0.146730F,-0.989177F,-0.427555F,0.740951F,0.857729F,-0.242980F,-0.998795F,-0.336890F,0.803208F},
	{-0.773010F,0.471397F,0.956940F,-0.098017F,-0.995185F,-0.290285F,0.881921F,0.634393F,-0.634393F,-0.881921F,0.290285F,0.995185F,0.098017F,-0.956940F,-0.471397F,0.773010F,
		0.773010F,-0.471397F,-0.956940F,0.098017F,0.995185F,0.290285F,-0.881921F,-0.634393F,0.634393F,0.881921F,-0.290285F,-0.995185F,-0.098017F,0.956940F,0.471397F,-0.773010F},
	{-0.740951F,0.595699F,0.857729F,-0.427555F,-0.941544F,0.242980F,0.989177F,-0.049068F,-0.998795F,-0.146730F,0.970031F,0.336890F,-0.903989F,-0.514103F,0.803208F,0.671559F,
		-0.671559F,-0.803208F,0.514103F,0.903989F,-0.336890F,-0.970031F,0.146730F,0.998795F,0.049068F,-0.989177F,-0.242980F,0.941544F,0.427555F,-0.857729F,-0.595699F,0.740951F}
};

// up to 32-bits
static unsigned jo_readBits(const unsigned char *data, unsigned *at, unsigned num)
{
	unsigned r = 0;
	// read partial starting bits
	unsigned sc = (8 - (*at & 7)) & 7;
	sc = sc > num ? num : sc;
	if(sc) {
		r = (data[*at/8] >> (8 - (*at&7) - sc)) & ((1<<sc)-1);
		num -= sc;
		*at += sc;
	}
	// read full bytes
	while(num>=8) {
		r <<= 8;
		r |= data[*at/8];
		*at += 8;
		num -= 8;
	}
	// read partial ending bits
	if(num) {
		r <<= num;
		r |= (data[*at/8] >> (8 - num)) & ((1<<num)-1);
		*at += num;
	}
	return r;
}


bool jo_read_mp1(const void *input, unsigned inputSize,
		short **output_, unsigned *outputSize_,
		unsigned *hz_, unsigned *channels_)
{
	unsigned outputSize = 0, hz = 0, channels = 0;
	short *output = 0;
	unsigned outputMax = 0;
	const unsigned char *data = (const unsigned char *)input;

	// Buffers for the lapped transform
	float buf[2][2 * 512] = { 0 };
	int bufOffset[2] = { 64,64 };
	unsigned at = 0; // Where in the stream are we?

	while (at < inputSize * 8) {
		// Sync markers are byte aligned
		at = (at + 7)&-8;
		while (at < inputSize * 8 - 32) {
			if (data[at / 8] == 0xFF && (data[at / 8 + 1] & 0xF0) == 0xF0) {
				break;
			}
			else {
				at += 8;
			}
		}
		if (at >= inputSize * 8 - 32) {
			break;
		}

		unsigned header = jo_readBits(data, &at, 32);
		//printf("header: %x.%x/%x: %08x\n", (at-32)/8, (at-32)&7, inputSize, header); 

		// sync = 0xFFF
		// ID = 1
		// layer = 3 (layer 1)
		if ((header & 0xFFFE0000) != 0xFFFE0000) {
			return false;
		}

		/* Check that bitrate is valid. */
		if((header ^ 0xF000) == 0)
			return false;
		
		static const unsigned hzTbl[4] = { 44100, 48000, 32000, 0 };
		hz = hzTbl[(header >> 10) & 3];
		if (!hz) {
			return false;
		}

		// mode 0 = stereo
		// mode 1 = joint stereo
		// mode 2 = dual channel (no idea what this does TODO)
		// mode 3 = mono
		unsigned mode = (header >> 6) & 3;
		unsigned modeExt = (header >> 4) & 3;
		channels = mode == 3 ? 1 : 2;
		const unsigned bound = mode == 1 ? (modeExt + 1) * 4 : 32;

		bool errorProtection = (header >> 16) & 1 ^ 1;
		if (errorProtection) {
			at += 16; // skip the CRC.
		}

		// Read bit allocations
		int bitAlloc[32][2] = { 0 };
		for (int i = 0; i < bound; ++i) {
			for (int ch = 0; ch < channels; ++ch) {
				bitAlloc[i][ch] = jo_readBits(data, &at, 4);
			}
		}
		for (int i = bound; i < 32; ++i) {
			bitAlloc[i][1] = bitAlloc[i][0] = jo_readBits(data, &at, 4);
		}

		// Read scale indexes
		int scaleIdx[32][2];
		for (int i = 0; i < 32; ++i) {
			for (int ch = 0; ch < channels; ++ch) {
				scaleIdx[i][ch] = bitAlloc[i][ch] ? jo_readBits(data, &at, 6) : 63;
			}
		}

		// Read & compute output samples
		short pcm[12][2][32];
		for (int s = 0; s < 12; ++s) {
			// Read normalized, quantized band samples
			int samples[32][2] = { 0 };
			for (int i = 0; i < bound; ++i) {
				for (int ch = 0; ch < channels; ++ch) {
					if (bitAlloc[i][ch]) {
						samples[i][ch] = jo_readBits(data, &at, bitAlloc[i][ch] + 1);
					}
				}
			}
			for (int i = bound; i < 32; ++i) {
				if (bitAlloc[i][0]) {
					samples[i][1] = samples[i][0] = jo_readBits(data, &at, bitAlloc[i][0] + 1);
				}
			}
			// Compute bands: Dequantize & Denormalize
			float bandTbl[2][32] = { 0 };
			for (int i = 0; i < 32; ++i) {
				for (int ch = 0; ch < channels; ++ch) {
					int b = bitAlloc[i][ch];
					if (b++) {
						int samp = samples[i][ch];
						float f = ((samp >> b - 1) & 1) ? 0 : -1;
						f += (samp & ((1 << b - 1) - 1)) / (float)(1 << b - 1);
						f = (f + 1.0 / (1 << b - 1)) * (1 << b) / ((1 << b) - 1.0);
						f *= s_jo_multTbl[scaleIdx[i][ch]];
						bandTbl[ch][i] = f;
					}
				}
			}
			// Convert subbands to PCM
			for (int ch = 0; ch < channels; ++ch) {
				bufOffset[ch] = (bufOffset[ch] + 0x3C0) & 0x3ff;
				float *bufOffsetPtr = buf[ch] + bufOffset[ch];
				const float *f = s_jo_filterTbl[0];
				for (int i = 0; i < 64; ++i) {
					float sum = 0;
					for (int j = 0; j < 32; ++j) {
						sum += *f++ * bandTbl[ch][j];
					}
					bufOffsetPtr[i] = sum;
				}
				const float *w = s_jo_windowTbl;
				for (int i = 0; i < 32; ++i) {
					float sum = 0;
					for (int j = 0; j < 16; ++j) {
						int k = i | (j + (j + 1 & -2)) << 5;
						sum += *w++ * buf[ch][(k + bufOffset[ch]) & 0x3ff];
					}
					int ss = (int)(sum * 0x8000);
					ss = ss > SHRT_MAX ? SHRT_MAX : ss < SHRT_MIN ? SHRT_MIN : ss;
					pcm[s][ch][i] = ss;
				}
			}
		}
		
		if (at > inputSize * 8)
			return false; /* Possible file corruption? */

		if (outputMax == 0) {
			// estimate total number of samples (may be totally wrong, but its better than nothing)
			at = (at + 7)&-8;
			outputMax = inputSize / (at / 8) * 384 * channels * sizeof(*output);
			output = (short*)realloc(output, outputMax);
		}
		if (outputSize * sizeof(*output) + 384 * channels * sizeof(*output) > outputMax) {
			outputMax += 384 * channels * sizeof(*output);
			output = (short*)realloc(output, outputMax);
		}
		for (int i = 0; i < 12; ++i) {
			for (int j = 0; j < 32; ++j) {
				for (int k = 0; k < channels; ++k) {
					output[outputSize++] = pcm[i][k][j];
				}
			}
		}
	}

	*outputSize_ = outputSize;
	*hz_ = hz;
	*channels_ = channels;
	*output_ = output;

	return outputSize && hz && channels && output;
}

#endif // JO_MP1_HEADER_FILE_ONLY

